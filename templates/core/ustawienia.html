{% extends "base.html" %}
{% block title %}Ustawienia konta{% endblock %}
{% block content %}
<div class="container py-5">
  <div class="card shadow-sm p-4">
    <h2 class="mb-4 text-primary"><i class="bi bi-gear-fill"></i> Ustawienia konta</h2>
    <p>Tu możesz zarządzać ustawieniami swojego konta, prywatnością i powiadomieniami.</p>

    {% if user.is_authenticated %}
      <div class="mb-3">
        <a href="{% url 'group_create' %}" class="btn btn-success me-2"><i class="bi bi-people-fill"></i> Utwórz czat grupowy</a>
        <a href="{% url 'group_list' %}" class="btn btn-outline-secondary">Moje grupy</a>
      </div>
    {% else %}
      <div class="mb-3">
        <a href="{% url 'login' %}?next={% url 'group_create' %}" class="btn btn-primary">Zaloguj, aby utworzyć czat grupowy</a>
      </div>
    {% endif %}

    <div class="row g-4">
      <div class="col-12 col-md-4">
        <div class="card h-100 border-0 shadow-sm mb-4">
          <div class="card-body text-center d-flex flex-column justify-content-between">
            <div>
              <div class="mb-3">
                <h5 class="mb-2 text-primary"><i class="bi bi-person-circle"></i> Zmień zdjęcie profilowe</h5>
                {% if profile.avatar %}
                  <img id="settings-avatar" src="{{ profile.avatar.url }}" alt="Avatar" class="rounded-circle border shadow-sm mb-2" style="width: 120px; height: 120px; object-fit: cover;">
                {% else %}
                  <div class="rounded-circle bg-light d-inline-flex align-items-center justify-content-center mb-2" style="width:120px; height:120px; border:1px solid #e9ecef;">
                    <i class="bi bi-person" style="font-size:48px; color:#adb5bd"></i>
                  </div>
                {% endif %}
              </div>
              <p class="text-muted small">Zaktualizuj swoje zdjęcie profilowe. Najlepiej kwadratowe zdjęcie JPG/PNG.</p>
            </div>
            <div class="mt-3">
              <button type="button" class="btn btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#changeAvatarModalSettings">
                <i class="bi bi-upload me-1"></i> Zmień zdjęcie
              </button>
            </div>

            <!-- Modal -->
            <div class="modal fade" id="changeAvatarModalSettings" tabindex="-1" aria-labelledby="changeAvatarModalSettingsLabel" aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="changeAvatarModalSettingsLabel">Zmień zdjęcie profilowe</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <form method="post" enctype="multipart/form-data" action="">
                    <div class="modal-body">
                      {% csrf_token %}
                      <div class="mb-3">
                        {{ profile_form.avatar.label_tag }}
                        <div class="input-group">
                          {{ profile_form.avatar }}
                        </div>
                        {% for error in profile_form.avatar.errors %}
                          <div class="text-danger small mt-1">{{ error }}</div>
                        {% endfor %}
                        {% if profile_form.non_field_errors %}
                          <div class="text-danger small mt-1">{{ profile_form.non_field_errors }}</div>
                        {% endif %}
                      </div>
                      <div class="form-text small text-muted">Maksymalny rozmiar zależy od serwera. Preferowane proporcje 1:1.</div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                      <button type="submit" name="change_avatar" class="btn btn-primary">Zapisz</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-md-4">
        <div class="card h-100 border-0 shadow-sm mb-4">
          <div class="card-body password-card d-flex flex-column">
            <div>
              <h5 class="mb-3 text-primary"><i class="bi bi-key"></i> Zmień hasło</h5>
              <form method="post" novalidate>
                {% csrf_token %}
                <div class="mb-3">
                  <label class="form-label">Aktualne hasło</label>
                  {{ password_form.old_password }}
                  {% for err in password_form.old_password.errors %}
                    <div class="text-danger small mt-1">{{ err }}</div>
                  {% endfor %}
                </div>
                <div class="mb-3">
                  <label class="form-label">Nowe hasło</label>
                  {{ password_form.new_password1 }}
                  {% if password_form.new_password1.help_text %}
                    <div class="form-text small">{{ password_form.new_password1.help_text }}</div>
                  {% endif %}
                  {% for err in password_form.new_password1.errors %}
                    <div class="text-danger small mt-1">{{ err }}</div>
                  {% endfor %}
                </div>
                <div class="mb-3">
                  <label class="form-label">Potwierdź nowe hasło</label>
                  {{ password_form.new_password2 }}
                  {% for err in password_form.new_password2.errors %}
                    <div class="text-danger small mt-1">{{ err }}</div>
                  {% endfor %}
                </div>
            </div>
            <div class="mt-auto d-grid">
              <button type="submit" name="change_password" class="btn btn-primary">Zmień hasło</button>
            </div>
              </form>
          </div>
        </div>
      </div>

      <div class="col-12 col-md-4">
        <div class="card h-100 border-0 shadow-sm mb-4">
          <div class="card-body d-flex flex-column">
            <div>
              <h5 class="mb-3 text-primary"><i class="bi bi-envelope-at"></i> Zmień e-mail</h5>
              <form method="post">
                {% csrf_token %}
                <div class="mb-3">
                  <label for="new_email" class="form-label">Nowy e-mail</label>
                  <input type="email" class="form-control" id="new_email" name="new_email" placeholder="nowy@przyklad.pl" required>
                </div>
                <div class="small text-muted mb-3">Po zmianie e-maila otrzymasz potwierdzenie na nowy adres (jeśli skonfigurowane).</div>
            </div>
            <div class="mt-auto d-grid">
              <button type="submit" name="change_email" class="btn btn-outline-primary">Zmień e-mail</button>
            </div>
              </form>
            {% if email_changed %}
              <div class="alert alert-success mt-3">E-mail został zmieniony.</div>
            {% endif %}
            <hr>
            <div>
              <h5 class="mb-3 text-primary"><i class="bi bi-telephone-fill"></i> Numer telefonu</h5>
              <form method="post">
                {% csrf_token %}
                <div class="mb-3">
                  <label for="new_phone" class="form-label">Numer telefonu</label>
                  <input type="text" class="form-control" id="new_phone" name="new_phone" placeholder="+48 123 456 789" value="{{ profile.phone_number|default:'' }}">
                </div>
            </div>
            <div class="mt-auto d-grid mb-2">
              <button type="submit" name="change_phone" class="btn btn-outline-primary">Zapisz numer telefonu</button>
            </div>
              </form>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-4">
        <div class="card h-100 border-0 shadow-sm mb-4">
          <div class="card-body d-flex flex-column">
            <div>
              <h5 class="mb-3 text-primary"><i class="bi bi-type"></i> Wygląd — czcionka</h5>
              <p class="small text-muted">Wybierz preferowaną czcionkę dla interfejsu.</p>
              <div class="mb-3">
                <label for="fontSelect" class="form-label">Czcionka</label>
                <select id="fontSelect" class="form-select">
                  <option value="system">System (domyślna)</option>
                  <option value="roboto">Roboto</option>
                  <option value="opensans">Open Sans</option>
                  <option value="merriweather">Merriweather (szeryfowa)</option>
                  <option value="mono">Monospace</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Podgląd</label>
                <div id="fontPreview" class="border p-3 rounded" style="min-height:56px;">Przykładowy tekst: Szybki brązowy lis przeskoczył nad leniwym psem.</div>
              </div>
            </div>
            <div class="mt-auto d-flex gap-2">
              <button id="saveFontBtn" class="btn btn-primary">Zapisz</button>
              <button id="resetFontBtn" class="btn btn-outline-secondary">Przywróć domyślną</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
// Small enhancement script: add Bootstrap classes to password inputs and improve file input UX
(function(){
  try {
    document.querySelectorAll('.password-card input[type="password"]').forEach(function(inp){
      if (!inp.classList.contains('form-control')) inp.classList.add('form-control');
      if (!inp.id) inp.id = inp.name || Math.random().toString(36).slice(2,8);
    });

    const modal = document.getElementById('changeAvatarModalSettings');
    if (modal) {
      const fileInput = modal.querySelector('input[type="file"]');
      if (fileInput) {
        fileInput.classList.add('form-control');
        // append filename helper
        var wrapper = fileInput.closest('.mb-3') || fileInput.parentNode;
        if (wrapper) {
          var info = document.createElement('div');
          info.className = 'small text-muted mt-2';
          info.id = 'avatar-modal-filename';
          info.textContent = 'Brak wybranego pliku';
          wrapper.appendChild(info);
          fileInput.addEventListener('change', function(){
            var f = this.files && this.files[0];
            info.textContent = f ? f.name : 'Brak wybranego pliku';
          });
        }
      }
    }
  } catch (err) { console.error('ustawienia small script error', err); }
})();
</script>
<script>
// Font selector behavior: initialize from localStorage and call applySiteFont if available
(function(){
  try{
    const select = document.getElementById('fontSelect');
    const preview = document.getElementById('fontPreview');
    const saveBtn = document.getElementById('saveFontBtn');
    const resetBtn = document.getElementById('resetFontBtn');
    const storageKey = 'siteFont';
    function setPreviewFont(name){
      // mirror the applySiteFont logic by setting style/font-family for preview
      const mapping = {
        'system': '',
        'roboto': 'Roboto, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial',
        'opensans': '"Open Sans", system-ui, -apple-system, "Segoe UI", Roboto, Arial',
        'merriweather': 'Merriweather, Georgia, Cambria, "Times New Roman", Times, serif',
        'mono': 'ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace'
      };
      if(preview) preview.style.fontFamily = mapping[name] || '';
    }

    // init select from storage
    const saved = (function(){ try{ return localStorage.getItem(storageKey); }catch(e){return null;} })() || 'system';
    if(select) { select.value = saved; setPreviewFont(saved); }

    // live preview on change
    if(select){ select.addEventListener('change', function(){ setPreviewFont(this.value); }); }

    if(saveBtn){ saveBtn.addEventListener('click', function(){
      const val = select ? select.value : 'system';
      try{ if(window.applySiteFont) window.applySiteFont(val); else localStorage.setItem(storageKey, val); }catch(e){}
      // visual feedback
      saveBtn.classList.add('disabled'); setTimeout(()=>saveBtn.classList.remove('disabled'),700);
    }); }

    if(resetBtn){ resetBtn.addEventListener('click', function(){
      if(select) { select.value = 'system'; setPreviewFont('system'); }
      try{ if(window.applySiteFont) window.applySiteFont('system'); else localStorage.removeItem(storageKey);}catch(e){}
    }); }

  }catch(err){ console.error('font selector error', err); }
})();
</script>
{% endblock %}
